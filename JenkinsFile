#!groovy
pipeline {
    agent { label "${CHOOSE_NODE}"}

    tools {
          	maven 'NBS Maven'
          	jdk 'JDK1.11'
        }

    parameters{
        choice (
                name: 'CHOOSE_NODE',
                choices: ['ansible-server2', 'ansible-server', 'ansible-server3',  'ansible-caas-test'],
                description: 'Executor to run the build on')
        string (
                name: 'GIT_SOURCE_BRANCH',
                defaultValue: 'main',
                description: 'Source Code Branch')
    }

    environment {
        M2_HOME = tool('NBS Maven')
        JAVA_HOME = tool('JDK1.11')
        PATH="${JAVA_HOME}/bin:${PATH}"
    }

    stages {

        stage('Preparation') {
            steps {
                script {
                    env.GIT_SOURCE_URL = 'https://github.com/nationwide-ccoe/nbs-cop-devtest.git'
                    env.mvnToolHome = tool('NBS Maven')
                }

            }
        }

        stage('Build-Deploy'){
            steps{
                script{
                    utilities_deploy("consumer-zodiac")
                }
            }
        }
    }
}


def utilities_deploy(String service_name) {
    env.service_name = service_name
    sh "${mvnToolHome}/bin/mvn -f ${service_name}/pom.xml clean test pact:publish"
    sh "${mvnToolHome}/bin/mvn spring-boot:run"
    sh "${mvnToolHome}/bin/mvn pact:verify"
    sh "${mvnToolHome}/bin/mvn spring-boot:stop"
}